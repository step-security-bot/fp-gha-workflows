name: Deploy storybook
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        description: Milj√∏ versjon som skal brukes til bygg.
        default: "ubuntu-latest"
      package-manager:
        required: false
        type: string
        description: Hvilken package manager en skal bruke (npm|pnpm|yarn)
        default: 'yarn'
      node-version:
        required: false
        type: string
        description: Node version som brukes.
        default: "18.8.0"
env:
  NODE_OPTIONS: '--max_old_space_size=6144'
permissions:
  contents: read

jobs:
  deploy-storybook:
    name: Deploy storybook ${{ inputs.package-manger }}
    permissions:
      contents: write
      pages: write
    environment: gh-pages
    runs-on: ${{ (github.actor == 'dependabot[bot]' && 'ubuntu-latest') || inputs.runs-on }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Sette yarn-config
        if: inputs.package-manager == 'yarn'
        run: |
          yarn config set npmScopes.navikt.npmRegistryServer "https://npm.pkg.github.com"
          yarn config set npmScopes.navikt.npmAlwaysAuth true
          yarn config set npmScopes.navikt.npmAuthToken $NPM_AUTH_TOKEN
        env:
          NPM_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}
      - uses: pnpm/action-setup@d882d12c64e032187b2edb46d3a0d003b7a43598 # ratchet:pnpm/action-setup@v2
        if: inputs.package-manager == 'pnpm'
        with:
          version: latest
      - name: Set up NODE med yarn cache
        if: inputs.package-manager == 'yarn'
        uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # ratchet:actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'yarn'
          cache-dependency-path: |
            node_modules/.cache/nx
            yarn.lock
      - name: Set up NODE med pnpm cache
        if: inputs.package-manager == 'pnpm'
        uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # ratchet:actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"
      - name: Yarn install
        if: inputs.package-manager == 'yarn'
        run: |
          yarn install --immutable
          yarn build
      - name: Pnpm install
        if: inputs.package-manager == 'pnpm'
        run: |
          pnpm install --frozen-lockfile
        env:
          GH_TOKEN: ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}
      - name: Set remote url med token
        run: git remote set-url origin https://git:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git
      - name: Deploy storybook yarn
        if: inputs.package-manager == 'yarn'
        run: |
          yarn storybook-clean-deploy-folder && yarn storybook-build-all && yarn storybook-create-deploy-folder
          yarn gh-pages -d .storybook-static-build -t true -u "github-actions-bot <support+actions@github.com>"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Deploy storybook pnpm
        if: inputs.package-manager == 'pnpm'
        run: |
          pnpm storybook-deploy-clean-folder && pnpm storybook-deploy-build-all && pnpm storybook-deploy-create-folder
          pnpm gh-pages -d .storybook-static-build -t true -u "github-actions-bot <support+actions@github.com>"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
